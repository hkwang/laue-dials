name: Build
run-name: Build by ${{ github.actor }}
on: [push]
jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
        os: [ubuntu-latest]

    steps:
    - name: Checkout source code
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Clean previous build
      run: |
        python -m pip install --upgrade pip
        pip install tox
        tox -e clean

#    - name: Install DIALS from binary
#      run: |
#        if [ "$RUNNER_OS" == "Linux" ]; then
#          wget https://dials.diamond.ac.uk/diamond_builds/dials-linux-x86_64-conda3.tar.xz
#          tar -xJf dials-linux-x86_64-conda3.tar.xz
#        elif [ "$RUNNER_OS" == "macOS" ]; then
#          curl https://dials.diamond.ac.uk/diamond_builds/dials-macosx-conda3.tar.gz > dials-macosx.tar.gz
#          tar -xzf dials-macosx.tar.gz
#        fi
#        cd dials-installer-dev
#        sudo ./install
#        source /usr/local/dials-dev*/dials_env.sh

    - name: Build with tox
      run: |
        tox -e build

    - name: Run tests with tox + pytest
      run: |
        tox

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
